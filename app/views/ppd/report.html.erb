<h1>Plan de Proceso Docente</h1>

<div class="control-group">
  <%= label_tag :career, t(:career).titleize, :class => 'control-label' %>
  <div class="controls">
    <%= select_tag :career, options_from_collection_for_select(Career.all, :id, :name), :class => 'text_field' %>
  </div>
</div>

<input type="hidden" id="career_id" value="<%= @career.id %>">

<div class="tabbable">
  <ul class="nav nav-tabs">
    <li class="active"><a href="#1" data-toggle="tab"><%= t(:presentation).titleize %></a></li>
    <li><a href="#2" data-toggle="tab">PPD</a></li>
    <li><a href="#3" data-toggle="tab">PPD Vivo</a></li>
    <li><a href="#3" data-toggle="tab">Malla Curricular</a></li>
  </ul>
  <div class="tab-content">
    <div class="tab-pane active" id="1">
      <dl class="dl-horizontal">
        <dt><strong><%= t(:faculty).titleize %>:</strong></dt>
        <dd><%= @career.faculty.name %></dd>
        <dt><strong><%= t(:career).titleize %>:</strong></dt>
        <dd><%= @career.name %></dd>
      </dl>
      <h2>Plan de estudio por años</h2>
      <table class="table table-striped table-bordered table-condensed">
        <tr>
          <th><%= t(:year).titleize %></th>
          <th>Plan</th>
        </tr>
        <% @career.years.each do |year| %>
            <tr>
              <td><%= year.name %></td>
              <td><%= year.study_plan.name %></td>
            </tr>
        <% end %>
      </table>
    </div>
    <div class="tab-pane" id="2">
      <table class="table table-bordered table-condensed ppd">
        <thead>
        <tr>
          <th rowspan="2">No</th>
          <th rowspan="2">Disciplina y Asignatura</th>
          <th colspan="3">Cantidad de horas</th>
          <th colspan="2">Tipo de Evaluación</th>
          <th colspan="5">Distribución de las horas por años</th>
        </tr>
        <tr>
          <th>Total</th>
          <th>Clase</th>
          <th>Laboral</th>
          <th>EF</th>
          <th>TC</th>
          <th>1</th>
          <th>2</th>
          <th>3</th>
          <th>4</th>
          <th>5</th>
        </tr>
        </thead>
        <tbody>
        <% CurriculumType.all.each do |ct| %>
            <tr class="curriculum-type">
              <td colspan="12"><%= ct.name %></td>
            </tr>
            <% @career.disciplines.each_with_index do |d, i| %>
                <% if d.subjects.any? { |s| s.curriculum_type == ct } %>
                    <tr class="discipline">
                      <td><%= i+1 %></td>
                      <td><%= d.name %></td>
                      <td><%= d.subjects.select { |s| s.curriculum_type==ct }.sum { |s| s.total_hours } %></td>
                      <td><%= d.subjects.select { |s| s.curriculum_type==ct }.sum { |s| s.class_hours } %></td>
                      <td><%= d.subjects.select { |s| s.curriculum_type==ct }.sum { |s| s.practical_hours } %></td>
                      <td><%= d.subjects.select { |s| s.curriculum_type==ct }.count { |s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_EXAMEN_FINAL } %></td>
                      <td><%= d.subjects.select { |s| s.curriculum_type==ct }.count { |s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_TRABAJO_CURSO } %></td>
                      <td><%= d.subjects.select { |s| s.semester.year.name=='1' }.sum { |s| s.total_hours } %></td>
                      <td><%= d.subjects.select { |s| s.semester.year.name=='2' }.sum { |s| s.total_hours } %></td>
                      <td><%= d.subjects.select { |s| s.semester.year.name=='3' }.sum { |s| s.total_hours } %></td>
                      <td><%= d.subjects.select { |s| s.semester.year.name=='4' }.sum { |s| s.total_hours } %></td>
                      <td><%= d.subjects.select { |s| s.semester.year.name=='5' }.sum { |s| s.total_hours } %></td>
                    </tr>
                    <% d.subjects.each_with_index do |s, j| %>
                        <% if s.curriculum_type == ct %>
                            <tr class="subject">
                              <td><%= i + 1 + (j+1).fdiv(100) %></td>
                              <td><%= s.name %></td>
                              <td><%= s.total_hours %></td>
                              <td><%= s.class_hours %></td>
                              <td><%= s.practical_hours %></td>
                              <td><%= s.semester.year.name if s.evaluation_type == ApplicationController::EVALUATION_TYPE_EXAMEN_FINAL %></td>
                              <td><%= s.semester.year.name if s.evaluation_type == ApplicationController::EVALUATION_TYPE_TRABAJO_CURSO %></td>
                              <td><%= s.total_hours if s.semester.year.name == '1' %></td>
                              <td><%= s.total_hours if s.semester.year.name == '2' %></td>
                              <td><%= s.total_hours if s.semester.year.name == '3' %></td>
                              <td><%= s.total_hours if s.semester.year.name == '4' %></td>
                              <td><%= s.total_hours if s.semester.year.name == '5' %></td>
                            </tr>
                        <% end %>
                    <% end %>
                <% end %>
            <% end %>
            <tr class="total">
              <td rowspan="3">TOTAL</td>
              <td><%= "HORAS  DEL CURRÍCULO #{I18n.transliterate(ct.name).upcase} POR  FORMA  Y POR AÑO" %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.curriculum_type==ct ? s.total_hours : 0 } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.curriculum_type==ct ? s.class_hours : 0 } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.curriculum_type==ct ? s.practical_hours : 0 } } %></td>
              <td></td>
              <td></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.curriculum_type==ct and s.semester.year.name=='1' }.to_a.sum { |s| s.total_hours } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.curriculum_type==ct and s.semester.year.name=='2' }.to_a.sum { |s| s.total_hours } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.curriculum_type==ct and s.semester.year.name=='3' }.to_a.sum { |s| s.total_hours } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.curriculum_type==ct and s.semester.year.name=='4' }.to_a.sum { |s| s.total_hours } } %></td>
              <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.curriculum_type==ct and s.semester.year.name=='5' }.to_a.sum { |s| s.total_hours } } %></td>
            </tr>
            <tr class="total">
              <td><%= "EXÁMENES FINALES DEL CURRÍCULO #{I18n.transliterate(ct.name).upcase}" %></td>
              <td></td><td></td><td></td>
              <td><%= @career.disciplines.to_a.sum{|d| d.subjects.select { |s| s.curriculum_type==ct}.count{|s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_EXAMEN_FINAL}  } %></td>
              <td></td><td></td><td></td><td></td><td></td><td></td>
            </tr>
            <tr class="total">
              <td><%= "TRABAJOS DE CURSO DEL CURRÍCULO #{I18n.transliterate(ct.name).upcase}" %></td>
              <td></td><td></td><td></td><td></td>
              <td><%= @career.disciplines.to_a.sum{|d| d.subjects.select { |s| s.curriculum_type==ct}.count{|s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_TRABAJO_CURSO}  } %></td>
              <td></td><td></td><td></td><td></td><td></td>
            </tr>
        <% end %>
        <tr class="curriculum-type">
          <td colspan="12">TOTALES</td>
        </tr>
        <tr class="total">
          <td rowspan="3">TOTAL</td>
          <td>HORAS DEL CURRÍCULO POR FORMA Y POR AÑO</td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.total_hours} } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.class_hours} } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.to_a.sum { |s| s.practical_hours} } %></td>
          <td></td>
          <td></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.semester.year.name=='1' }.to_a.sum { |s| s.total_hours } } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.semester.year.name=='2' }.to_a.sum { |s| s.total_hours } } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.semester.year.name=='3' }.to_a.sum { |s| s.total_hours } } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.semester.year.name=='4' }.to_a.sum { |s| s.total_hours } } %></td>
          <td><%= @career.disciplines.to_a.sum { |d| d.subjects.select { |s| s.semester.year.name=='5' }.to_a.sum { |s| s.total_hours } } %></td>
        </tr>
        <tr class="total">
          <td>EXÁMENES FINALES DEL CURRÍCULO Y POR AÑO</td>
          <td></td><td></td><td></td>
          <td><%= @career.disciplines.to_a.sum{|d| d.subjects.count{|s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_EXAMEN_FINAL}  } %></td>
          <td></td><td></td><td></td><td></td><td></td><td></td>
        </tr>
        <tr class="total">
          <td>TRABAJOS DE CURSO DEL CURRÍCULO Y POR AÑO</td>
          <td></td><td></td><td></td><td></td>
          <td><%= @career.disciplines.to_a.sum{|d| d.subjects.count{|s| s.evaluation_type == ApplicationController::EVALUATION_TYPE_TRABAJO_CURSO}  } %></td>
          <td></td><td></td><td></td><td></td><td></td>
        </tr>

        <tr><td colspan="12"></td></tr>
        <tr class="total">
          <td></td><td colspan="2">ESTRUCTURA EN PORCIENTO</td><td></td><td></td>
          <td colspan="7">EVALUACIONES POR AÑO</td>
        </tr>
        <tr class="total">
          <td></td><td>EVALUACIONES POR AÑO</td>
        </tr>
        </tbody>
      </table>
    </div>
    <div class="tab-pane" id="3">
      <p>Howdy, I'm in Section 3.</p>
    </div>
    <div class="tab-pane" id="4">
      <p>Howdy, I'm in Section 4.</p>
    </div>
  </div>
</div>


